name: Build LaTeX document
on: [workflow_dispatch, push]
jobs:
  build_latex:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Set up Git repository
        uses: actions/checkout@v4
      - name: Compile LaTeX document
        uses: xu-cheng/latex-action@v4
        with:
          root_file: optimal-control.tex
          latexmk_shell_escape: true
          extra_system_packages: "inkscape ghostscript"
      - name: Generate release metadata (UTC)
        id: release_meta
        run: |
          echo "tag=$(date -u +'%Y%m%d-%H%M%S')" >> $GITHUB_OUTPUT
          echo "name=$(date -u +'%Y-%m-%d %H:%M UTC')" >> $GITHUB_OUTPUT
      - name: Upload PDF file
        uses: actions/upload-artifact@v4
        with:
          name: PDF
          path: optimal-control.pdf
      - name: Create Release
        if: github.ref == 'refs/heads/main'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.release_meta.outputs.tag }}
          name: PDF Build (${{ steps.release_meta.outputs.name }})
          body: "Automatically generated PDF from latest commit on ${{ steps.release_meta.outputs.name }}"
          files: optimal-control.pdf
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Delete all previous releases and tags
        if: github.ref == 'refs/heads/main'
        uses: actions/github-script@v7
        with:
          script: |
            const core = require('@actions/core');
            const { owner, repo } = context.repo;
            const keepTag = '${{ steps.release_meta.outputs.tag }}';
            core.info(`Keeping latest release/tag: ${keepTag}`);
            const releases = await github.paginate(github.rest.repos.listReleases, { owner, repo });
            for (const rel of releases) {
              if (rel.tag_name !== keepTag) {
                core.info(`Deleting release id=${rel.id} tag=${rel.tag_name}`);
                try {
                  await github.rest.repos.deleteRelease({ owner, repo, release_id: rel.id });
                } catch (e) {
                  core.warning(`Failed to delete release for tag ${rel.tag_name}: ${e.message}`);
                }
                // Attempt to delete the tag ref as well to avoid clutter
                try {
                  await github.rest.git.deleteRef({ owner, repo, ref: `tags/${rel.tag_name}` });
                } catch (e) {
                  core.warning(`Failed to delete tag ${rel.tag_name}: ${e.message}`);
                }
              }
            }
            core.info('Old releases cleanup finished.');
